<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Attendance Register</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#007bff">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="MGSG App">
<link rel="icon" href="https://raw.githubusercontent.com/Prince431497/Prabh/main/app-icon.png" type="image/png">
  <style>
    body { font-family: Arial, sans-serif; background: #eef2f7; padding: 30px; }
    .container { background: white; padding: 30px; max-width: 500px; margin: auto; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    input, button, select { width: 100%; padding: 12px; margin-top: 12px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; }
    button { background: #007bff; color: white; cursor: pointer; border: none; transition: 0.3s; }
    button:hover { background: #0056b3; }
    .hidden { display: none; }
    .main-buttons { display: flex; flex-direction: column; gap: 20px; margin-top: 20px; }
    .main-buttons button { font-size: 20px; padding: 18px; background: #007bff; }
    .main-buttons button:hover { background: #0056b3; }
    #mis-dashboard { background: #f9f9f9; padding: 20px; border-radius: 8px; }
    #mis-dashboard h4 { margin-top: 10px; }
    ul { padding-left: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
    th { background-color: #007bff; color: white; }
    .spinner-border { display: inline-block; width: 1rem; height: 1rem; border: 2px solid currentColor; border-radius: 50%; border-right-color: transparent; animation: spin 0.75s linear infinite; }
    .spinner-border-sm { width: 0.875rem; height: 0.875rem; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .me-2 { margin-right: 0.5rem; }
    .btn-outline-info { background: transparent; border: 2px solid #17a2b8; color: #17a2b8; }
    .btn-outline-info:hover { background: #17a2b8; color: white; }
    .btn-lg { padding: 15px 25px; font-size: 18px; }
    .team-allocation-table { max-width: 100%; overflow-x: auto; }
    .team-allocation-table table { min-width: 600px; }
    .team-allocation-table th, .team-allocation-table td { min-width: 100px; white-space: nowrap; }
  </style>
</head>
<body>
  <div class="container">
    <h2 id="form-title">Login</h2>
    <div id="login-form">
      <input type="text" id="login-name" placeholder="Name" required>
      <input type="text" id="login-code" placeholder="Employee Code" required>
      <input type="password" id="login-password" placeholder="Password" required>
      <button onclick="handleLogin()">Login</button>
    </div>

    <div id="main-menu" class="hidden">
      <h3 id="welcome-msg"></h3>
      <div class="main-buttons">
        <button onclick="showAttendanceSection()">Attendance</button>
        <button onclick="showExpenseSection()">Out of Pocket Expense</button>
        <button onclick="showTimesheetSection()">Timesheet</button>
        <button onclick="showMISDashboard()">MIS Dashboard</button>
        <button onclick="showChangePassword()">Change Password</button>
        <button onclick="showTimesheetDownload()">Check Timesheet</button>
        <button onclick="showExpenseDownload()">Check Expense</button>
<button onclick="showCreateInvoice()" id="create-invoice-btn" style="display:none;">Create Invoice</button>
      </div>
    </div>

    <div id="attendance-section" class="hidden">
      <input list="client-list" id="client-name" placeholder="Search and select client" required>
      <datalist id="client-list"></datalist>

      <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button onclick="markAttendance('In')">Mark In</button>
        <button onclick="markAttendance('Out')">Mark Out</button>
      </div>
      <button onclick="showAttendanceDownload()">Check Attendance</button>
      <button onclick="backToMenu()" style="background:#6c757d;margin-top:10px;">Back</button>
    </div>

    <!-- Attendance Download Section -->
    <div id="attendance-download-section" class="hidden">
      <h3>Download Attendance</h3>
      <label>From Date</label>
      <input type="date" id="att-start">
      <label>To Date</label>
      <input type="date" id="att-end">
      <button onclick="downloadAttendance()">Download</button>
      <button onclick="backToAttendance()" style="background:#6c757d;margin-top:10px;">Back</button>
    </div>

    <!-- Timesheet Download Section -->
    <div id="timesheet-download-section" class="hidden">
      <h3>Download Timesheet</h3>
      <label>From Date</label>
      <input type="date" id="ts-start">
      <label>To Date</label>
      <input type="date" id="ts-end">
      <button onclick="downloadTimesheet()">Download</button>
      <button onclick="backToMenu()" style="background:#6c757d;margin-top:10px;">Back</button>
    </div>

    <!-- Expense Download Section -->
    <div id="expense-download-section" class="hidden">
      <h3>Download Expenses</h3>
      <label>From Date</label>
      <input type="date" id="exp-start">
      <label>To Date</label>
      <input type="date" id="exp-end">
      <button onclick="downloadExpense()">Download</button>
      <button onclick="backToMenu()" style="background:#6c757d;margin-top:10px;">Back</button>
    </div>

    <div id="timesheet-section" class="hidden">
      <label>Employee Name</label>
      <input type="text" id="ts-name" readonly>
      <label>Employee Code</label>
      <input type="text" id="ts-code" readonly>
      <label>Date</label>
      <input type="date" id="ts-date">
      <label>Client Name</label>
      <input list="ts-client-list" id="ts-client" placeholder="Search and select client" required>
      <datalist id="ts-client-list"></datalist>
      <label>Hours Worked</label>
      <input type="number" id="ts-hours" min="0" step="0.25">
      <button onclick="submitTimesheet()">Save</button>
      <button onclick="backToMenu()" style="background:#6c757d;margin-top:10px;">Back</button>
    </div>

    <!-- Updated MIS Dashboard Section -->
<div id="mis-dashboard" class="hidden">
  <h3>MIS Dashboard</h3>
  <div class="main-buttons">
    <button onclick="showHoursBooked()" class="btn btn-outline-info btn-lg">
      <i class="fas fa-clock"></i> Check Hours Booked
    </button>
    <button onclick="showEmployeeAttendance()" class="btn btn-outline-info btn-lg">
      <i class="fas fa-users"></i> Check Employee Attendance
    </button>
    <button onclick="showTeamAllocation()" class="btn btn-outline-info btn-lg">
      <i class="fas fa-users"></i> Team Allocation
    </button>
<button onclick="showClientListCheck()" class="btn btn-outline-info btn-lg">
  <i class="fas fa-building"></i> Check Client List
</button>
  </div>
  <button onclick="backToMenu()" style="margin-top:20px; background:#6c757d;">Back</button>
</div>

<div id="hours-booked-section" class="hidden">
  <h3>Hours Booked Report</h3>
  
  <!-- Report Type Selection -->
  <label>Report Type</label>
  <select id="hours-report-type" onchange="showHoursReportOptions()" required>
    <option value="">-- Select Report Type --</option>
    <option value="employee-wise">Employee Wise Hours</option>
    <option value="client-wise">Client Wise Hours</option>
  </select>
  
  <!-- Employee-wise options -->
  <div id="employee-wise-options" class="hidden">
    <label>Select Employee</label>
    <select id="employee-select" required>
      <option value="">-- Select Employee --</option>
    </select>
  </div>
  
  <!-- Date range (common for both) -->
  <div id="date-range-options" class="hidden">
    <label>From Date</label>
    <input type="date" id="hours-from-date" required>
    <label>To Date</label>
    <input type="date" id="hours-to-date" required>
    <button onclick="generateHoursReport()">Generate Report</button>
  </div>
  
  <!-- Results container -->
  <div id="hours-report-results" style="margin-top: 20px;"></div>
  
  <button onclick="backToMIS()" style="background:#6c757d;margin-top:10px;">Back to MIS</button>
</div>

<!-- Employee Attendance Section -->
<div id="employee-attendance-section" class="hidden">
  <h3>Employee Attendance Check</h3>
  <label>Select Date</label>
  <input type="date" id="attendance-check-date" value="">
  <button onclick="loadEmployeeAttendance()">Check Attendance</button>
  
  <div id="attendance-summary" style="margin-top: 20px;">
    <div id="present-employees"></div>
    <div id="absent-employees"></div>
  </div>
  
  <button onclick="backToMIS()" style="background:#6c757d;margin-top:10px;">Back to MIS</button>
</div>

    <!-- Team Allocation Section -->
    <div id="team-allocation-section" class="hidden">
      <h3>Team Allocation</h3>
      <label>From Date</label>
      <input type="date" id="team-start">
      <label>To Date</label>
      <input type="date" id="team-end">
      <button onclick="loadTeamAllocation()">Load Team Data</button>
      <div id="team-allocation-table" class="team-allocation-table"></div>
      <button onclick="backToMIS()" style="background:#6c757d;margin-top:10px;">Back to MIS</button>
    </div>

<div id="client-list-section" class="hidden">
  <h3>Client List Check</h3>
  <label>Select Date</label>
  <input type="date" id="client-check-date" value="">
  <button onclick="loadClientList()">Check Clients</button>
  
  <div id="client-summary" style="margin-top: 20px;">
    <div id="clients-with-attendance"></div>
    <div id="clients-without-attendance"></div>
  </div>
  
  <button onclick="backToMIS()" style="background:#6c757d;margin-top:10px;">Back to MIS</button>
</div>

    <div id="change-password-section" class="hidden">
      <h3>Change Password</h3>
      <label>Employee Code</label>
      <input type="text" id="cp-code" readonly>
      <label>Old Password</label>
      <input type="password" id="cp-old" required>
      <label>New Password</label>
      <input type="password" id="cp-new" required>
      <button onclick="submitPasswordChange()">Change Password</button>
      <button onclick="backToMenu()" style="background:#6c757d;margin-top:10px;">Back</button>
    </div>

    <!-- Out of Pocket Expense Section -->
    <div id="expense-section" class="hidden">
      <h3>Out of Pocket Expense</h3>
      <label>Employee Name</label>
      <input type="text" id="exp-name" readonly>
      <label>Employee Code</label>
      <input type="text" id="exp-code" readonly>
      <label>Date</label>
      <input type="date" id="exp-date" required>
      <label>Client Name</label>
      <input list="exp-client-list" id="exp-client" placeholder="Search and select client" required>
      <datalist id="exp-client-list"></datalist>
      <label>Expense Type</label>
      <select id="exp-type" required>
        <option value="">-- Select Type --</option>
        <option value="Travel">Travel</option>
        <option value="Food">Food</option>
        <option value="Stationery">Stationery</option>
        <option value="Accommodation">Accommodation</option>
        <option value="Others">Others</option>
      </select>
      <label>Amount (₹)</label>
      <input type="number" id="exp-amount" required>
      <label>Remarks</label>
      <input type="text" id="exp-remarks">
      <button onclick="submitExpense()">Submit Expense</button>
      <button onclick="backToMenu()" style="background:#6c757d;margin-top:10px;">Back</button>
    </div>
<!-- Create Invoice Section -->
<div id="create-invoice-section" class="hidden">
  <h3>Create Invoice</h3>
  <label>Client Name</label>
  <input list="invoice-client-list" id="invoice-client" placeholder="Search and select client" required>
  <datalist id="invoice-client-list"></datalist>
  
  <label>Nature of Service</label>
  <select id="nature-of-service" onchange="showServiceForm()" required>
    <option value="">-- Select Service Type --</option>
    <option value="Internal Audit">Internal Audit</option>
    <option value="FAR">FAR</option>
    <option value="Stock Audit">Stock Audit</option>
    <option value="Certificate">Certificate</option>
    <option value="Special Assignment">Special Assignment</option>
    <option value="Statutory Audit">Statutory Audit</option>
    <option value="Accounting">Accounting</option>
    <option value="Retainership">Retainership</option>
  </select>

  <!-- Service-specific forms will appear here -->
  <div id="service-forms"></div>
  
  <button onclick="backToMenu()" style="background:#6c757d;margin-top:10px;">Back</button>
</div>

  </div>

  <script>
    function setLoading(button, isLoading, text) {
      if (!button) return;

      button.disabled = isLoading;
      button.innerHTML = isLoading
        ? `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>${text}`
        : text;
    }

    const scriptURL = 'https://script.google.com/macros/s/AKfycbys-t3G0SpBnftPby7oGc6nFqdWlQ_NZdPwQwSlRHVS9OQdrRqQgyOlsXLWlJ7azfWW/exec';
    let currentUser = {};

    function toggleForm(type) {
      document.getElementById('form-title').innerText = type === 'register' ? 'Register' : 'Login';
      document.getElementById('login-form').classList.toggle('hidden', type === 'register');
      hideAllSections();
    }

    function hideAllSections() {
  const sections = [
    'main-menu', 'attendance-section', 'timesheet-section', 'mis-dashboard', 
    'attendance-download-section', 'timesheet-download-section', 'expense-download-section',
    'change-password-section', 'expense-section', 'team-allocation-section',
    'hours-booked-section', 'employee-attendance-section' , 'create-invoice-section' , 'client-list-section'
  ];
  sections.forEach(section => {
    document.getElementById(section).classList.add('hidden');
  });
}

    function handleLogin() {
      const name = document.getElementById('login-name').value.trim();
      const code = document.getElementById('login-code').value.trim();
      const password = document.getElementById('login-password').value.trim();
      const loginBtn = document.querySelector('button[onclick="handleLogin()"]');
      
      if (!name || !code || !password) {
        alert('Please fill in all fields.');
        return;
      }

      setLoading(loginBtn, true, "Wait, Logging in...");

      fetch(scriptURL + `?action=login&name=${encodeURIComponent(name)}&code=${encodeURIComponent(code)}&password=${encodeURIComponent(password)}`)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            const role = data.role || 'User';
            currentUser = { name, code, role };

            document.getElementById('welcome-msg').innerText = `Welcome, ${name}`;
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');

            // Hide MIS Dashboard button if not Admin
            const misDashboardBtn = document.querySelector("button[onclick='showMISDashboard()']");
const createInvoiceBtn = document.getElementById('create-invoice-btn'); // ADD THIS
            if (role !== 'Admin' && misDashboardBtn) {
              misDashboardBtn.style.display = "none";
            }
if (role === 'Admin' && createInvoiceBtn) {
  createInvoiceBtn.style.display = "block";
}

          } else {
            alert('Invalid credentials.');
          }
        })
        .catch(err => {
          console.error(err);
          alert('Error during login. Please try again.');
        })
        .finally(() => {
          setLoading(loginBtn, false, "Login");
        });
    }
    
    function showAttendanceSection() {
      hideAllSections();
      document.getElementById('attendance-section').classList.remove('hidden');
      loadClients('client-name');
    }

    function showTimesheetSection() {
      hideAllSections();
      document.getElementById('timesheet-section').classList.remove('hidden');
      document.getElementById('ts-name').value = currentUser.name;
      document.getElementById('ts-code').value = currentUser.code;
      loadClients('ts-client');
    }

    function showExpenseSection() {
      hideAllSections();
      document.getElementById('expense-section').classList.remove('hidden');
      document.getElementById('exp-name').value = currentUser.name;
      document.getElementById('exp-code').value = currentUser.code;
      loadClients('exp-client');
    }

   

    function showChangePassword() {
      hideAllSections();
      document.getElementById('change-password-section').classList.remove('hidden');
      document.getElementById('cp-code').value = currentUser.code;
    }

    function showTimesheetDownload() {
      hideAllSections();
      document.getElementById('timesheet-download-section').classList.remove('hidden');
    }

    function showExpenseDownload() {
      hideAllSections();
      document.getElementById('expense-download-section').classList.remove('hidden');
    }

    function showAttendanceDownload() {
      hideAllSections();
      document.getElementById('attendance-download-section').classList.remove('hidden');
    }

    function showTeamAllocation() {
      hideAllSections();
      document.getElementById('team-allocation-section').classList.remove('hidden');
    }

    function backToMenu() {
      hideAllSections();
      document.getElementById('main-menu').classList.remove('hidden');
    }

    function backToAttendance() {
      hideAllSections();
      document.getElementById('attendance-section').classList.remove('hidden');
    }

    function backToMIS() {
  hideAllSections();
  
  // Clear attendance results when going back to MIS
  const presentEmployees = document.getElementById('present-employees');
  const absentEmployees = document.getElementById('absent-employees');
  const attendanceCheckDate = document.getElementById('attendance-check-date');
  const attendanceSummary = document.getElementById('attendance-summary');
  
  if (presentEmployees) presentEmployees.innerHTML = '';
  if (absentEmployees) absentEmployees.innerHTML = '';
  if (attendanceCheckDate) attendanceCheckDate.value = '';
  if (attendanceSummary) attendanceSummary.innerHTML = '';
  
  // Clear hours booked data
  const hoursReportType = document.getElementById('hours-report-type');
  const hoursFromDate = document.getElementById('hours-from-date');
  const hoursToDate = document.getElementById('hours-to-date');
  const hoursReportResults = document.getElementById('hours-report-results');
  const dateRangeOptions = document.getElementById('date-range-options');
  
  if (hoursReportType) hoursReportType.value = '';
  if (hoursFromDate) hoursFromDate.value = '';
  if (hoursToDate) hoursToDate.value = '';
  if (hoursReportResults) hoursReportResults.innerHTML = '';
  if (dateRangeOptions) dateRangeOptions.classList.add('hidden');
  
  // Clear team allocation data
  const teamAllocationTable = document.getElementById('team-allocation-table');
  if (teamAllocationTable) teamAllocationTable.innerHTML = '';
  
  // Clear client list data
  const clientsWithAttendance = document.getElementById('clients-with-attendance');
  const clientsWithoutAttendance = document.getElementById('clients-without-attendance');
  const clientCheckDate = document.getElementById('client-check-date');
  
  if (clientsWithAttendance) clientsWithAttendance.innerHTML = '';
  if (clientsWithoutAttendance) clientsWithoutAttendance.innerHTML = '';
  if (clientCheckDate) clientCheckDate.value = '';
  
  // Show MIS dashboard
  document.getElementById('mis-dashboard').classList.remove('hidden');
}


    function submitTimesheet() {
      const date = document.getElementById('ts-date').value;
      const client = document.getElementById('ts-client').value;
      const hours = document.getElementById('ts-hours').value;

      if (!date || !client || !hours) {
        alert("Please fill all fields.");
        return;
      }

      const submitBtn = document.querySelector('button[onclick="submitTimesheet()"]');
      setLoading(submitBtn, true, "Saving...");

      fetch(scriptURL, {
        method: 'POST',
        body: new URLSearchParams({
          action: 'submitTimesheet',
          name: currentUser.name,
          code: currentUser.code,
          date,
          client,
          hours
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          alert('Timesheet saved successfully.');
          document.getElementById('ts-date').value = '';
          document.getElementById('ts-client').value = '';
          document.getElementById('ts-hours').value = '';
        } else {
          alert('Error saving timesheet.');
        }
      })
      .catch(err => {
        console.error(err);
        alert('Error submitting timesheet.');
      })
      .finally(() => {
        setLoading(submitBtn, false, "Save");
      });
    }

    function loadClients(inputId) {
      fetch(scriptURL + '?action=getClients')
        .then(response => response.json())
        .then(data => {
          if (!data.clients || data.clients.length === 0) return;

          let datalistId = '';
          if (inputId === 'client-name') datalistId = 'client-list';
          else if (inputId === 'ts-client') datalistId = 'ts-client-list';
          else if (inputId === 'exp-client') datalistId = 'exp-client-list';
else if (inputId === 'invoice-client') datalistId = 'invoice-client-list'; // ADD THIS LINE

          const datalist = document.getElementById(datalistId);
          if (datalist) {
            datalist.innerHTML = '';
            data.clients.forEach(client => {
              const option = document.createElement('option');
              option.value = client;
              datalist.appendChild(option);
            });
          }
        })
        .catch(err => console.error('Error loading clients:', err));
    }

    
    function markAttendance(status) {
      const client = document.getElementById('client-name').value;
      if (!client) {
        alert("Please select a client.");
        return;
      }

      const button = document.querySelector(`button[onclick="markAttendance('${status}')"]`);
      setLoading(button, true, `Marking ${status}...`);

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const location = `(${lat.toFixed(4)}, ${lon.toFixed(4)})`;

            fetch(scriptURL, {
              method: 'POST',
              body: new URLSearchParams({
                action: 'markAttendance',
                name: currentUser.name,
                code: currentUser.code,
                status,
                client,
                location,
                lat,
                lon
              })
            })
            .then(res => res.json())
            .then(data => {
              if (data.status === 'success') {
                alert(`✅ Attendance marked ${status} at ${data.time}`);
                backToMenu();
              } else if (data.status === 'already_marked') {
                alert(`⚠️ You have already marked attendance today at ${data.time}.`);
              } else {
                alert(data.message || '❌ Attendance marking failed.');
              }
            })
            .catch(err => {
              alert("⚠️ Error while marking attendance.");
              console.error(err);
            })
            .finally(() => {
              setLoading(button, false, `Mark ${status}`);
            });
          },
          () => {
            alert("📍 Location permission denied or unavailable.");
            setLoading(button, false, `Mark ${status}`);
          }
        );
      } else {
        alert("📍 Geolocation not supported.");
        setLoading(button, false, `Mark ${status}`);
      }
    }

    function submitPasswordChange() {
      const code = document.getElementById('cp-code').value.trim();
      const oldPass = document.getElementById('cp-old').value.trim();
      const newPass = document.getElementById('cp-new').value.trim();

      if (!oldPass || !newPass) {
        alert("Please fill both old and new passwords.");
        return;
      }

      const changeBtn = document.querySelector('button[onclick="submitPasswordChange()"]');
      setLoading(changeBtn, true, "Changing...");

      fetch(scriptURL, {
        method: 'POST',
        body: new URLSearchParams({
          action: 'changePassword',
          code,
          oldPass,
          newPass
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          alert("Password changed successfully.");
          document.getElementById('cp-old').value = '';
          document.getElementById('cp-new').value = '';
          backToMenu();
        } else {
          alert(data.message || "Failed to change password.");
        }
      })
      .catch(err => {
        alert("Error changing password.");
        console.error(err);
      })
      .finally(() => {
        setLoading(changeBtn, false, "Change Password");
      });
    }

    function submitExpense() {
      const name = document.getElementById('exp-name').value.trim();
      const code = document.getElementById('exp-code').value.trim();
      const date = document.getElementById('exp-date').value;
      const client = document.getElementById('exp-client').value.trim();
      const type = document.getElementById('exp-type').value;
      const amount = document.getElementById('exp-amount').value;
      const remarks = document.getElementById('exp-remarks').value.trim();

      if (!date || !client || !type || !amount) {
        alert("⚠️ Please fill all required fields.");
        return;
      }

      const button = document.querySelector('button[onclick="submitExpense()"]');
      setLoading(button, true, "Submitting...");

      fetch(scriptURL, {
        method: 'POST',
        body: new URLSearchParams({
          action: 'submitExpense',
          name,
          code,
          date,
          client,
          type,
          amount,
          remarks
        })
      })
        .then(res => res.json())
        .then(data => {
          if (data.status === 'success') {
            alert("✅ Expense submitted successfully.");
            document.getElementById('exp-date').value = '';
            document.getElementById('exp-client').value = '';
            document.getElementById('exp-type').value = '';
            document.getElementById('exp-amount').value = '';
            document.getElementById('exp-remarks').value = '';
          } else {
            alert(data.message || "❌ Submission failed.");
          }
        })
        .catch(err => {
          alert("❌ Error while submitting expense.");
          console.error(err);
        })
        .finally(() => setLoading(button, false, "Submit Expense"));
    }

    function downloadAttendance() {
      const start = document.getElementById('att-start').value;
      const end = document.getElementById('att-end').value;
const downloadBtn = document.querySelector('button[onclick="downloadAttendance()"]');


      if (!start || !end) {
        showMessage('attendance-message', 'Please select both start and end dates.', true);
        return;
      }


      if (new Date(start) > new Date(end)) {
        showMessage('attendance-message', 'Start date cannot be after end date.', true);
        return;
      }


      setLoading(downloadBtn, true, "Downloading...");

        
      fetch(`${scriptURL}?action=downloadAttendance&code=${currentUser.code}&start=${start}&end=${end}`)
 .then(res => res.json())       
        .then(data => {
  if (data.status === 'no_data') {
    alert(data.message);
    return;
  }        
  
          if (data.status === 'success'&& data.csvData) {
const blob = new Blob([data.csvData], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = data.filename || `Attendance_${currentUser.code}_${start}_${end}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);  
alert("✅ Timesheet downloaded.");
        backToMenu();
      } else {
        alert(data.message || "❌ Unable to download Attendance.");
      }
    })
.catch(err => {
      console.error(err);
      alert("❌ Error downloading Attendance.");
    })
    .finally(() => setLoading(downloadBtn, false, "Download"));
}          

function downloadTimesheet() {
  const start = document.getElementById('ts-start').value;
  const end = document.getElementById('ts-end').value;
  const downloadBtn = document.querySelector('button[onclick="downloadTimesheet()"]');

  if (!start || !end) {
    alert("Please select both start and end dates.");
    return;
  }

  setLoading(downloadBtn, true, "Downloading...");

  fetch(`${scriptURL}?action=downloadTimesheet&code=${currentUser.code}&start=${start}&end=${end}`)
    .then(res => res.json())
    .then(data => {
      if (data.status === 'no_data') {
        alert(data.message);
        return;
      }
      if (data.status === 'success' && data.csvData) {
        // Create blob and download
        const blob = new Blob([data.csvData], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = data.filename || `Timesheet_${currentUser.code}_${start}_${end}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        alert("✅ Timesheet downloaded.");
        backToMenu();
      } else {
        alert(data.message || "❌ Unable to download timesheet.");
      }
    })
    .catch(err => {
      console.error(err);
      alert("❌ Error downloading timesheet.");
    })
    .finally(() => setLoading(downloadBtn, false, "Download"));
}


function downloadExpense() {
  const start = document.getElementById('ts-start').value;
  const end = document.getElementById('ts-end').value;
  const downloadBtn = document.querySelector('button[onclick="downloadExpense()"]');

  if (!start || !end) {
    alert("Please select both start and end dates.");
    return;
  }

  setLoading(downloadBtn, true, "Downloading...");

  fetch(`${scriptURL}?action=downloadExpense&code=${currentUser.code}&start=${start}&end=${end}`)
    .then(res => res.json())
    .then(data => {
      if (data.status === 'no_data') {
        alert(data.message);
        return;
      }
      if (data.status === 'success' && data.csvData) {
        // Create blob and download
        const blob = new Blob([data.csvData], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = data.filename || `Expense_${currentUser.code}_${start}_${end}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        alert("✅ Expense downloaded.");
        backToMenu();
      } else {
        alert(data.message || "❌ Unable to download Expense.");
      }
    })
    .catch(err => {
      console.error(err);
      alert("❌ Error downloading Expense.");
    })
    .finally(() => setLoading(downloadBtn, false, "Download"));
}

// Updated MIS Dashboard Functions

function showMISDashboard() {
  hideAllSections();
  document.getElementById('mis-dashboard').classList.remove('hidden');
  // Don't load data automatically anymore - let user choose what to view
}

function showHoursBooked() {
  hideAllSections();
  document.getElementById('hours-booked-section').classList.remove('hidden');
  loadAuditEmployees(); // Load audit team employees for dropdown
}

function showEmployeeAttendance() {
  hideAllSections();
  document.getElementById('employee-attendance-section').classList.remove('hidden');
  // Set today's date as default
  document.getElementById('attendance-check-date').value = new Date().toISOString().split('T')[0];
}

function loadHoursBookedData() {
  fetch(scriptURL + '?action=misDashboard')
    .then(res => res.json())
    .then(data => {
      document.getElementById('mis-leads').innerHTML = `<h4>Current Leads:</h4><ul>${data.leads.map(item => `<li>${item}</li>`).join('')}</ul>`;
      document.getElementById('mis-clients').innerHTML = `<h4>Active Clients with Total Hours:</h4><table><tr><th>Client</th><th>Total Hours (Month)</th></tr>${data.clients.map((client, idx) => `<tr><td>${client}</td><td>${data.clientHours[idx]}</td></tr>`).join('')}</table>`;
      document.getElementById('mis-employees').innerHTML = `<h4>Present Employees:</h4><table><tr><th>Employee</th><th>Client</th></tr>${data.presentEmployeeClients.map(row => `<tr><td>${row.name}</td><td>${row.client}</td></tr>`).join('')}</table>`;
    })
    .catch(err => {
      console.error(err);
      alert('Error loading Hours Booked data.');
    });
}

function loadEmployeeAttendance() {
  const selectedDate = document.getElementById('attendance-check-date').value;
  
  if (!selectedDate) {
    alert('Please select a date.');
    return;
  }

  const loadBtn = document.querySelector('button[onclick="loadEmployeeAttendance()"]');
  setLoading(loadBtn, true, "Loading...");

  fetch(scriptURL + `?action=checkEmployeeAttendance&date=${selectedDate}`)
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        displayEmployeeAttendance(data);
      } else {
        alert(data.message || 'Error loading employee attendance.');
      }
    })
    .catch(err => {
      console.error(err);
      alert('Error loading employee attendance.');
    })
    .finally(() => {
      setLoading(loadBtn, false, "Check Attendance");
    });
}


// Replace your displayEmployeeAttendance function with this corrected version:

function displayEmployeeAttendance(data) {
  const presentDiv = document.getElementById('present-employees');
  const absentDiv = document.getElementById('absent-employees');
  
  // Debug: Log the received data to console
  console.log('Received attendance data:', data);
  
  // Display Present Employees
  if (data.presentEmployees && data.presentEmployees.length > 0) {
    let presentHtml = '<h4 style="color: green;">Present Employees(Audit):</h4>';
    presentHtml += '<table><tr><th>Employee Name</th><th>Client</th><th>Time In</th></tr>';
    
    data.presentEmployees.forEach(emp => {
      presentHtml += `<tr>
        <td>${emp.name || emp.employeeName || 'N/A'}</td>
        <td>${emp.client || emp.clientName || 'N/A'}</td>
        <td>${emp.timeIn || emp.time || emp.timestamp || 'N/A'}</td>
      </tr>`;
    });
    
    presentHtml += '</table>';
    presentDiv.innerHTML = presentHtml;
  } else {
    presentDiv.innerHTML = '<h4 style="color: green;">Present Employees(Audit):</h4><p>No employees marked present.</p>';
  }
  
  // Display Absent Employees
  if (data.absentEmployees && data.absentEmployees.length > 0) {
    let absentHtml = '<h4 style="color: red;">Absent Employees(Audit):</h4>';
    absentHtml += '<table><tr><th>Employee Name</th></tr>';
    
    data.absentEmployees.forEach(emp => {
      absentHtml += `<tr>
        <td>${emp.name || emp.employeeName || 'N/A'}</td>
      </tr>`;
    });
    
    absentHtml += '</table>';
    absentDiv.innerHTML = absentHtml;
  } else {
    absentDiv.innerHTML = '<h4 style="color: red;">Absent Employees(Audit):</h4><p>All active employees are present.</p>';
  }
}

// Also update the loadEmployeeAttendance function to include better error handling:

function loadEmployeeAttendance() {
  const selectedDate = document.getElementById('attendance-check-date').value;
  
  if (!selectedDate) {
    alert('Please select a date.');
    return;
  }

  const loadBtn = document.querySelector('button[onclick="loadEmployeeAttendance()"]');
  setLoading(loadBtn, true, "Loading...");

  fetch(scriptURL + `?action=checkEmployeeAttendance&date=${selectedDate}&team=Audit`)
    .then(res => res.json())
    .then(data => {
      console.log('Backend response:', data); // Debug log
      
      if (data.status === 'success') {
        displayEmployeeAttendance(data);
      } else {
        alert(data.message || 'Error loading employee attendance.');
        // Show debug info
        console.error('Backend error:', data);
      }
    })
    .catch(err => {
      console.error('Fetch error:', err);
      alert('Error loading employee attendance.');
    })
    .finally(() => {
      setLoading(loadBtn, false, "Check Attendance");
    });
}

function showCreateInvoice() {
  hideAllSections();
  document.getElementById('create-invoice-section').classList.remove('hidden');
  loadClients('invoice-client');
  // Set today's date as default
  document.getElementById('invoice-date').value = new Date().toISOString().split('T')[0];
}

function generateInvoice() {
  const client = document.getElementById('invoice-client').value;
  const invoiceDate = document.getElementById('invoice-date').value;
  const fromDate = document.getElementById('invoice-from').value;
  const toDate = document.getElementById('invoice-to').value;
  const rate = document.getElementById('invoice-rate').value;

  if (!client || !invoiceDate || !fromDate || !toDate || !rate) {
    alert("Please fill all fields.");
    return;
  }

  const generateBtn = document.querySelector('button[onclick="generateInvoice()"]');
  setLoading(generateBtn, true, "Generating...");

  fetch(scriptURL, {
    method: 'POST',
    body: new URLSearchParams({
      action: 'createInvoice',
      client,
      invoiceDate,
      fromDate,
      toDate,
      rate,
      adminCode: currentUser.code
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === 'success') {
      alert("✅ Invoice generated successfully.");
      // Clear form
      document.getElementById('invoice-client').value = '';
      document.getElementById('invoice-from').value = '';
      document.getElementById('invoice-to').value = '';
      document.getElementById('invoice-rate').value = '';
    } else {
      alert(data.message || "❌ Invoice generation failed.");
    }
  })
  .catch(err => {
    console.error(err);
    alert("❌ Error generating invoice.");
  })
  .finally(() => setLoading(generateBtn, false, "Generate Invoice"));
}

// Replace the entire showServiceForm() function with this:

function showServiceForm() {
  const serviceType = document.getElementById('nature-of-service').value;
  const formsContainer = document.getElementById('service-forms');
  
  if (!serviceType) {
    formsContainer.innerHTML = '';
    return;
  }

  let formHTML = '';

  switch(serviceType) {
    case 'Internal Audit':
      formHTML = `
        <h4>Internal Audit Details</h4>
        <label>Description of Services</label>
        <textarea id="audit-description" rows="3" placeholder="Describe the internal audit services" required></textarea>
        <label>Audit Period From</label>
        <input type="date" id="audit-from" required>
        <label>Audit Period To</label>
        <input type="date" id="audit-to" required>
        <label>Taxable Amount</label>
        <input type="number" id="audit-taxable" min="0" required>
        <label>Out of Pocket Expense Period</label>
        <input type="text" id="audit-expense-period" required>
        <label>Remarks, If Any</label>
        <textarea id="audit-remarks" rows="2" placeholder="Enter remarks if any"></textarea>
        <button onclick="generateServiceInvoice('Internal Audit')">Generate Internal Audit Invoice</button>
      `;
      break;

    case 'FAR':
      formHTML = `
        <h4>FAR (Fixed Asset Register) Details</h4>
        <label>Description of Services</label>
        <textarea id="far-description" rows="3" placeholder="Describe the FAR services" required></textarea>
        <label>Service Date</label>
        <input type="date" id="far-date" required>
        <label>Taxable Amount</label>
        <input type="number" id="far-taxable" min="0" required>
        <label>Out of Pocket Expense If any</label>
        <input type="number" id="far-expense" min="0" value="0">
        <label>Remarks, If Any</label>
        <textarea id="far-remarks" rows="2" placeholder="Enter remarks if any"></textarea>
        <button onclick="generateServiceInvoice('FAR')">Generate FAR Invoice</button>
      `;
      break;

    case 'Stock Audit':
      formHTML = `
        <h4>Stock Audit Details</h4>
        <label>Description of Services</label>
        <textarea id="stock-description" rows="3" placeholder="Describe the stock audit services" required></textarea>
        <label>From Date</label>
        <input type="date" id="stock-from" required onchange="calculateManDays()">
        <label>To Date</label>
        <input type="date" id="stock-to" required onchange="calculateManDays()">
        <label>Location Name</label>
        <input type="text" id="stock-location" required>
        <label>Number of Person</label>
        <input type="number" id="stock-persons" min="1" required onchange="calculateManDays()">
        <label>Total Man days</label>
        <input type="number" id="stock-mandays" readonly>
        <label>Rate Per Man days</label>
        <input type="number" id="stock-rate-mandays" min="0" required onchange="calculateTaxableAmount()">
        <label>Taxable Amount</label>
        <input type="number" id="stock-taxable" readonly>
        <button onclick="generateServiceInvoice('Stock Audit')">Generate Stock Audit Invoice</button>
      `;
      break;

    case 'Certificate':
      formHTML = `
        <h4>Certificate Details</h4>
        <label>Description of Services</label>
        <textarea id="cert-description" rows="3" placeholder="Describe the certificate services" required></textarea>
        <label>Certificate Date</label>
        <input type="date" id="cert-date" required>
        <label>Certificate Type</label>
        <select id="cert-type" required>
          <option value="">-- Select Type --</option>
          <option value="Net Worth">Net Worth Certificate</option>
          <option value="Turnover">Turnover Certificate</option>
          <option value="Balance Confirmation">Balance Confirmation</option>
          <option value="Other">Other</option>
        </select>
        <label>UDIN</label>
        <input type="text" id="cert-udin" placeholder="Enter UDIN" required>
        <label>Taxable Amount</label>
        <input type="number" id="cert-taxable" min="0" required>
        <button onclick="generateServiceInvoice('Certificate')">Generate Certificate Invoice</button>
      `;
      break;

    case 'Special Assignment':
      formHTML = `
        <h4>Special Assignment Details</h4>
        <label>Description of Services</label>
        <textarea id="assignment-description" rows="3" placeholder="Describe the special assignment services" required></textarea>
        <label>Assignment Description</label>
        <textarea id="assignment-desc" rows="3" placeholder="Describe the assignment" required></textarea>
        <label>Start Date</label>
        <input type="date" id="assignment-start" required>
        <label>End Date</label>
        <input type="date" id="assignment-end" required>
        <label>Billing Type</label>
        <select id="assignment-billing" required>
          <option value="">-- Select Billing --</option>
          <option value="hourly">Hourly Rate</option>
          <option value="daily">Daily Rate</option>
          <option value="fixed">Fixed Amount</option>
        </select>
        <label>Rate/Amount (₹)</label>
        <input type="number" id="assignment-rate" min="0" required>
        <label>Quantity (Hours/Days)</label>
        <input type="number" id="assignment-quantity" min="0">
        <button onclick="generateServiceInvoice('Special Assignment')">Generate Assignment Invoice</button>
      `;
      break;

    case 'Statutory Audit':
      formHTML = `
        <h4>Statutory Audit Details</h4>
        <label>Description of Services</label>
        <textarea id="statutory-description" rows="3" placeholder="Describe the statutory audit services" required></textarea>
        <label>Financial Year</label>
        <input type="text" id="statutory-fy" placeholder="e.g., 2023-24" required>
        <label>Audit Type</label>
        <select id="statutory-type" required>
          <option value="">-- Select Type --</option>
          <option value="Company">Company Audit</option>
          <option value="Partnership">Partnership Firm</option>
          <option value="LLP">LLP Audit</option>
          <option value="Trust">Trust/Society</option>
        </select>
        <label>Annual Turnover (₹)</label>
        <input type="number" id="statutory-turnover" min="0" required>
        <label>Audit Fees (₹)</label>
        <input type="number" id="statutory-fees" min="0" required>
        <button onclick="generateServiceInvoice('Statutory Audit')">Generate Statutory Audit Invoice</button>
      `;
      break;

    case 'Accounting':
      formHTML = `
        <h4>Accounting Services Details</h4>
        <label>Description of Services</label>
        <textarea id="accounting-description" rows="3" placeholder="Describe the accounting services" required></textarea>
        <label>Service Period From</label>
        <input type="date" id="accounting-from" required>
        <label>Service Period To</label>
        <input type="date" id="accounting-to" required>
        <label>Service Type</label>
        <select id="accounting-type" required>
          <option value="">-- Select Type --</option>
          <option value="Bookkeeping">Bookkeeping</option>
          <option value="GST Returns">GST Returns</option>
          <option value="TDS Returns">TDS Returns</option>
          <option value="Financial Statements">Financial Statements</option>
          <option value="Complete Accounting">Complete Accounting</option>
        </select>
        <label>Monthly Charges (₹)</label>
        <input type="number" id="accounting-monthly" min="0" required>
        <label>Number of Months</label>
        <input type="number" id="accounting-months" min="1" required>
        <button onclick="generateServiceInvoice('Accounting')">Generate Accounting Invoice</button>
      `;
      break;

    case 'Retainership':
      formHTML = `
        <h4>Retainership Details</h4>
        <label>Description of Services</label>
        <textarea id="retainer-description" rows="3" placeholder="Describe the retainership services" required></textarea>
        <label>Retainer Period From</label>
        <input type="date" id="retainer-from" required>
        <label>Retainer Period To</label>
        <input type="date" id="retainer-to" required>
        <label>Services Covered</label>
        <textarea id="retainer-services" rows="3" placeholder="List services covered under retainership" required></textarea>
        <label>Monthly Retainer (₹)</label>
        <input type="number" id="retainer-monthly" min="0" required>
        <label>Number of Months</label>
        <input type="number" id="retainer-months" min="1" required>
        <button onclick="generateServiceInvoice('Retainership')">Generate Retainership Invoice</button>
      `;
      break;
  }

  formsContainer.innerHTML = formHTML;
}

// Add these new functions for Stock Audit calculations:

function calculateManDays() {
  const fromDate = document.getElementById('stock-from').value;
  const toDate = document.getElementById('stock-to').value;
  const persons = document.getElementById('stock-persons').value;
  
  if (fromDate && toDate && persons) {
    const startDate = new Date(fromDate);
    const endDate = new Date(toDate);
    const timeDiff = endDate.getTime() - startDate.getTime();
    const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1; // +1 to include both start and end date
    
    const totalManDays = daysDiff * parseInt(persons);
    document.getElementById('stock-mandays').value = totalManDays;
    
    // Also calculate taxable amount if rate is available
    calculateTaxableAmount();
  }
}

function calculateTaxableAmount() {
  const manDays = document.getElementById('stock-mandays').value;
  const ratePerManDay = document.getElementById('stock-rate-mandays').value;
  
  if (manDays && ratePerManDay) {
    const taxableAmount = parseFloat(manDays) * parseFloat(ratePerManDay);
    document.getElementById('stock-taxable').value = taxableAmount;
  }
}

// Replace the entire collectServiceData() function with this:

function collectServiceData(serviceType) {
  let data = {};
  
  try {
    switch(serviceType) {
      case 'Internal Audit':
        data = {
          description: document.getElementById('audit-description').value,
          auditFrom: document.getElementById('audit-from').value,
          auditTo: document.getElementById('audit-to').value,
          taxableAmount: document.getElementById('audit-taxable').value,
          expensePeriod: document.getElementById('audit-expense-period').value,
          remarks: document.getElementById('audit-remarks').value || ''
        };
        break;
        
      case 'FAR':
        data = {
          description: document.getElementById('far-description').value,
          serviceDate: document.getElementById('far-date').value,
          taxableAmount: document.getElementById('far-taxable').value,
          expenseIfAny: document.getElementById('far-expense').value || 0,
          remarks: document.getElementById('far-remarks').value || ''
        };
        break;
        
      case 'Stock Audit':
        data = {
          description: document.getElementById('stock-description').value,
          fromDate: document.getElementById('stock-from').value,
          toDate: document.getElementById('stock-to').value,
          locationName: document.getElementById('stock-location').value,
          numberOfPersons: document.getElementById('stock-persons').value,
          totalManDays: document.getElementById('stock-mandays').value,
          ratePerManDay: document.getElementById('stock-rate-mandays').value,
          taxableAmount: document.getElementById('stock-taxable').value
        };
        break;
        
      case 'Certificate':
        data = {
          description: document.getElementById('cert-description').value,
          certificateDate: document.getElementById('cert-date').value,
          certificateType: document.getElementById('cert-type').value,
          udin: document.getElementById('cert-udin').value,
          taxableAmount: document.getElementById('cert-taxable').value
        };
        break;
        
      case 'Special Assignment':
        data = {
          description: document.getElementById('assignment-description').value,
          assignmentDesc: document.getElementById('assignment-desc').value,
          startDate: document.getElementById('assignment-start').value,
          endDate: document.getElementById('assignment-end').value,
          billingType: document.getElementById('assignment-billing').value,
          rate: document.getElementById('assignment-rate').value,
          quantity: document.getElementById('assignment-quantity').value || 0
        };
        break;
        
      case 'Statutory Audit':
        data = {
          description: document.getElementById('statutory-description').value,
          financialYear: document.getElementById('statutory-fy').value,
          auditType: document.getElementById('statutory-type').value,
          turnover: document.getElementById('statutory-turnover').value,
          fees: document.getElementById('statutory-fees').value
        };
        break;
        
      case 'Accounting':
        data = {
          description: document.getElementById('accounting-description').value,
          serviceFrom: document.getElementById('accounting-from').value,
          serviceTo: document.getElementById('accounting-to').value,
          serviceType: document.getElementById('accounting-type').value,
          monthlyCharges: document.getElementById('accounting-monthly').value,
          months: document.getElementById('accounting-months').value
        };
        break;
        
      case 'Retainership':
        data = {
          description: document.getElementById('retainer-description').value,
          retainerFrom: document.getElementById('retainer-from').value,
          retainerTo: document.getElementById('retainer-to').value,
          servicesCovered: document.getElementById('retainer-services').value,
          monthlyRetainer: document.getElementById('retainer-monthly').value,
          months: document.getElementById('retainer-months').value
        };
        break;
    }
    
    // Validate required fields (skip empty optional fields like remarks)
    for (let key in data) {
      if (!data[key] && data[key] !== 0 && !['remarks', 'expenseIfAny', 'quantity'].includes(key)) {
        alert(`Please fill all required fields for ${serviceType}.`);
        return null;
      }
    }
    
    return data;
  } catch (error) {
    alert('Error collecting form data. Please check all fields.');
    return null;
  }
}

function generateServiceInvoice(serviceType) {
  const client = document.getElementById('invoice-client').value;
  
  if (!client) {
    alert("Please select a client.");
    return;
  }

  const generateBtn = document.querySelector(`button[onclick="generateServiceInvoice('${serviceType}')"]`);
  setLoading(generateBtn, true, "Generating...");

  // Collect service-specific data
  const serviceData = collectServiceData(serviceType);
  
  if (!serviceData) {
    setLoading(generateBtn, false, `Generate ${serviceType} Invoice`);
    return;
  }

  fetch(scriptURL, {
    method: 'POST',
    body: new URLSearchParams({
      action: 'createServiceInvoice',
      client,
      serviceType,
      serviceData: JSON.stringify(serviceData),
      adminCode: currentUser.code
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === 'success') {
      alert(`✅ ${serviceType} invoice generated successfully.`);
      // Clear form
      document.getElementById('invoice-client').value = '';
      document.getElementById('nature-of-service').value = '';
      document.getElementById('service-forms').innerHTML = '';
    } else {
      alert(data.message || `❌ ${serviceType} invoice generation failed.`);
    }
  })
  .catch(err => {
    console.error(err);
    alert(`❌ Error generating ${serviceType} invoice.`);
  })
  .finally(() => setLoading(generateBtn, false, `Generate ${serviceType} Invoice`));
}

function showClientListCheck() {
  hideAllSections();
  document.getElementById('client-list-section').classList.remove('hidden');
  // Set today's date as default
  document.getElementById('client-check-date').value = new Date().toISOString().split('T')[0];
}

function loadClientList() {
  const selectedDate = document.getElementById('client-check-date').value;
  
  if (!selectedDate) {
    alert('Please select a date.');
    return;
  }

  const loadBtn = document.querySelector('button[onclick="loadClientList()"]');
  setLoading(loadBtn, true, "Loading...");

  fetch(scriptURL + `?action=checkClientList&date=${selectedDate}`)
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        displayClientList(data);
      } else {
        alert(data.message || 'Error loading client list.');
      }
    })
    .catch(err => {
      console.error(err);
      alert('Error loading client list.');
    })
    .finally(() => {
      setLoading(loadBtn, false, "Check Clients");
    });
}

function displayClientList(data) {
  const withAttendanceDiv = document.getElementById('clients-with-attendance');
  const withoutAttendanceDiv = document.getElementById('clients-without-attendance');
  
  // Display Clients WITH attendance
  if (data.clientsWithAttendance && data.clientsWithAttendance.length > 0) {
    let withAttendanceHtml = '<h4 style="color: green;">Clients with Attendance:</h4>';
    withAttendanceHtml += '<table><tr><th>Client Name</th><th>Employee Count</th></tr>';
    
    data.clientsWithAttendance.forEach(client => {
      withAttendanceHtml += `<tr>
        <td>${client.name || 'N/A'}</td>
        <td>${client.employeeCount || 0}</td>
      </tr>`;
    });
    
    withAttendanceHtml += '</table>';
    withAttendanceDiv.innerHTML = withAttendanceHtml;
  } else {
    withAttendanceDiv.innerHTML = '<h4 style="color: green;">Clients with Attendance:</h4><p>No clients have attendance marked.</p>';
  }
  
  // Display Clients WITHOUT attendance
  if (data.clientsWithoutAttendance && data.clientsWithoutAttendance.length > 0) {
    let withoutAttendanceHtml = '<h4 style="color: red;">Clients without Attendance:</h4>';
    withoutAttendanceHtml += '<table><tr><th>Client Name</th></tr>';
    
    data.clientsWithoutAttendance.forEach(client => {
      withoutAttendanceHtml += `<tr>
        <td>${client.name || client || 'N/A'}</td>
      </tr>`;
    });
    
    withoutAttendanceHtml += '</table>';
    withoutAttendanceDiv.innerHTML = withoutAttendanceHtml;
  } else {
    withoutAttendanceDiv.innerHTML = '<h4 style="color: red;">Clients without Attendance:</h4><p>All clients have attendance marked.</p>';
  }
}

function showHoursReportOptions() {
  const reportType = document.getElementById('hours-report-type').value;
  const employeeOptions = document.getElementById('employee-wise-options');
  const dateRangeOptions = document.getElementById('date-range-options');
  const resultsDiv = document.getElementById('hours-report-results');
  
  // Clear previous results
  resultsDiv.innerHTML = '';
  
  if (reportType === 'employee-wise') {
    employeeOptions.classList.remove('hidden');
    dateRangeOptions.classList.remove('hidden');
  } else if (reportType === 'client-wise') {
    employeeOptions.classList.add('hidden');
    dateRangeOptions.classList.remove('hidden');
  } else {
    employeeOptions.classList.add('hidden');
    dateRangeOptions.classList.add('hidden');
  }
}

function loadAuditEmployees() {
  fetch(scriptURL + '?action=getAuditEmployees')
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success' && data.employees) {
        const employeeSelect = document.getElementById('employee-select');
        employeeSelect.innerHTML = '<option value="">-- Select Employee --</option>';
        
        data.employees.forEach(employee => {
          const option = document.createElement('option');
          option.value = employee.code;
          option.textContent = `${employee.name} (${employee.code})`;
          employeeSelect.appendChild(option);
        });
      }
    })
    .catch(err => console.error('Error loading audit employees:', err));
}

function generateHoursReport() {
  const reportType = document.getElementById('hours-report-type').value;
  const fromDate = document.getElementById('hours-from-date').value;
  const toDate = document.getElementById('hours-to-date').value;
  
  if (!reportType || !fromDate || !toDate) {
    alert('Please fill all required fields.');
    return;
  }
  
  if (new Date(fromDate) > new Date(toDate)) {
    alert('From date cannot be after To date.');
    return;
  }
  
  let employeeCode = '';
  if (reportType === 'employee-wise') {
    employeeCode = document.getElementById('employee-select').value;
    if (!employeeCode) {
      alert('Please select an employee.');
      return;
    }
  }
  
  const generateBtn = document.querySelector('button[onclick="generateHoursReport()"]');
  setLoading(generateBtn, true, "Generating Report...");
  
  const params = new URLSearchParams({
    action: 'getHoursBookedReport',
    reportType: reportType,
    fromDate: fromDate,
    toDate: toDate
  });
  
  if (employeeCode) {
    params.append('employeeCode', employeeCode);
  }
  
  fetch(scriptURL + '?' + params.toString())
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        displayHoursReport(data, reportType);
      } else {
        alert(data.message || 'Error generating report.');
      }
    })
    .catch(err => {
      console.error(err);
      alert('Error generating report.');
    })
    .finally(() => setLoading(generateBtn, false, "Generate Report"));
}

function displayHoursReport(data, reportType) {
  const resultsDiv = document.getElementById('hours-report-results');
  let html = '';
  
  if (reportType === 'employee-wise') {
    html = `
      <h4 style="color: #007bff;">Employee Hours Report: ${data.employeeName}</h4>
      <p><strong>Date Range:</strong> ${data.fromDate} to ${data.toDate}</p>
      <p><strong>Total Hours:</strong> ${data.totalHours} hours</p>
      
      <h5>Top 5 Clients (Hours Booked):</h5>
    `;
    
    if (data.clientHours && data.clientHours.length > 0) {
      html += '<table><tr><th>Rank</th><th>Client Name</th><th>Hours Booked</th><th>Percentage</th></tr>';
      
      data.clientHours.forEach((client, index) => {
        const percentage = data.totalHours > 0 ? ((client.hours / data.totalHours) * 100).toFixed(1) : 0;
        html += `<tr>
          <td>${index + 1}</td>
          <td>${client.clientName}</td>
          <td>${client.hours}</td>
          <td>${percentage}%</td>
        </tr>`;
      });
      
      html += '</table>';
    } else {
      html += '<p>No hours booked for this employee in the selected period.</p>';
    }
    
  } else if (reportType === 'client-wise') {
    html = `
      <h4 style="color: #007bff;">Client-wise Hours Report</h4>
      <p><strong>Date Range:</strong> ${data.fromDate} to ${data.toDate}</p>
      <p><strong>Total Hours (All Clients):</strong> ${data.totalHours} hours</p>
      
      <h5>Client-wise Breakdown:</h5>
    `;
    
    if (data.clientHours && data.clientHours.length > 0) {
      html += '<table><tr><th>Client Name</th><th>Total Hours</th><th>Percentage</th></tr>';
      
      data.clientHours.forEach(client => {
        const percentage = data.totalHours > 0 ? ((client.hours / data.totalHours) * 100).toFixed(1) : 0;
        html += `<tr>
          <td>${client.clientName}</td>
          <td>${client.hours}</td>
          <td>${percentage}%</td>
        </tr>`;
      });
      
      html += '</table>';
    } else {
      html += '<p>No hours booked for any client in the selected period.</p>';
    }
  }
  
  resultsDiv.innerHTML = html;
}

</script>
  </script>
</body>
</html>
